<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Gingerbolt</title>
<style>
  :root{ --vh:1vh; --bg:#12161c; --pink:#ff4081; --pink-hi:#ff6fa3; --indigo:#5865F2; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body{
    margin:0; padding:0; background:var(--bg); color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    height:100%; overflow:hidden; touch-action:manipulation; -webkit-user-select:none; user-select:none;
  }
  canvas{
    display:block; margin:0 auto; background:#000;
    width:100vw; height:calc(var(--vh) * 100);
    backface-visibility:hidden; -webkit-backface-visibility:hidden; transform:translateZ(0); will-change:transform;
    position:relative; z-index:0;
  }
  .stack{ position:fixed; left:50%; transform:translateX(-50%); width:min(92vw,520px); z-index:1000; pointer-events:auto; }
  .stack[hidden]{ display:none; }
  #frontStack .buttons{ display:flex; flex-direction:column; gap:12px; align-items:center; }
  .btn{ border:0; border-radius:18px; padding:14px 22px; font-size:18px; color:#fff; box-shadow:0 10px 26px rgba(0,0,0,.35); cursor:pointer; }
  .btn:active{ transform:translateY(1px) scale(.98); }
  .btn-primary{ background:linear-gradient(180deg,var(--pink-hi),var(--pink)); font-weight:800; min-width:220px; }
  .btn-indigo{ background:var(--indigo); min-width:220px; }
  .controls{ position:fixed; inset:0; pointer-events:none; z-index:10; }
  .controls[hidden]{ display:none; }
  .laneBtn{
    position:absolute; width:72px; height:72px; border:none; border-radius:18px;
    background:rgba(0,0,0,.35); color:#fff; font-size:28px; box-shadow:0 6px 18px rgba(0,0,0,.35);
    pointer-events:auto; transform:translate(-50%,-50%);
  }
  .laneBtn:active{ transform:translate(-50%,-50%) scale(.96); }
  @media (min-width:900px){ .controls{ display:none!important; } }
</style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="frontStack" class="stack" hidden>
    <div class="buttons">
      <button id="startBtn" class="btn btn-primary" type="button">Start Game</button>
      <button id="changeNameBtn" class="btn btn-indigo" type="button">Change Name</button>
    </div>
  </div>

  <div id="controls" class="controls" hidden>
    <button id="btnLane1" class="laneBtn" aria-label="Move left">◀</button>
    <button id="btnLane3" class="laneBtn" aria-label="Move right">▶</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
/* ========================= Supabase Leaderboard ========================= */
const SUPABASE_URL='https://fvcvrhaxxpsientgggnx.supabase.co';
const SUPABASE_ANON_KEY='YOUR_KEY_HERE';
const TABLE_NAME='highscores';
const supa=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const NAME_KEY='catdash_name';
function getPlayerName(){
  let n=localStorage.getItem(NAME_KEY);
  if(!n){ n=prompt('Enter player name (3–12 chars):','CAT')||'CAT'; n=n.trim().slice(0,12); if(n.length<3) n=(n+'CAT').slice(0,3); localStorage.setItem(NAME_KEY,n); }
  return n;
}
let globalBoard=[]; let lastBoardFetch=0;
async function fetchGlobalTop(limit=20){
  try{
    const {data,error}=await supa.from(TABLE_NAME).select('name,score,updated_at').order('score',{ascending:false}).limit(limit);
    if(error) throw error; globalBoard=Array.isArray(data)?data:[]; lastBoardFetch=performance.now();
  }catch(e){ console.warn('LB fetch error',e.message||e); }
}
async function submitBestIfHigher(name,score){
  try{
    const {data:existing,error:e1}=await supa.from(TABLE_NAME).select('score').eq('name',name).single();
    const prev=Number(existing?.score||0); if(!e1 && score<=prev) return false;
    const payload={name,score,updated_at:new Date().toISOString()};
    const {error:e2}=await supa.from(TABLE_NAME).upsert(payload,{onConflict:'name'});
    if(e2) throw e2; fetchGlobalTop(20); return true;
  }catch(e){ console.warn('LB submit error',e.message||e); return false; }
}

/* ========================= Canvas setup ========================= */
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
let W=innerWidth,H=innerHeight;
function resizeCanvas(){ W=innerWidth; H=innerHeight; canvas.width=W; canvas.height=H; }
resizeCanvas(); addEventListener('resize',resizeCanvas);
function lanesX(){ return [W/4, W/2, (3*W)/4]; }

/* ========================= Game state ========================= */
let mode='front'; let lastScore=0;
let currentLane=1,enemies=[],pickups=[],particles=[];
let score=0,fuel=100,meters=0;
let cheatActive=false,lives=1;
let cheatToastText='',cheatToastTimer=0;

/* ========================= Inputs ========================= */
let lastLeftTime=0,lastRightTime=0;
document.addEventListener('keydown',e=>{
  if(mode!=='game') return;
  const now=performance.now();
  if(e.key==='ArrowLeft'){ if(currentLane>0) currentLane--; lastLeftTime=now; }
  if(e.key==='ArrowRight'){ if(currentLane<2) currentLane++; lastRightTime=now; }
  if(Math.abs(lastLeftTime-lastRightTime)<150 && !cheatActive){
    cheatActive=true; lives=2;
    cheatToastText='Cheat Mode: 2 Lives'; cheatToastTimer=2.0;
  }
});
btnLeft.addEventListener('click',()=>{
  if(mode!=='game') return;
  const now=performance.now(); if(currentLane>0) currentLane--; lastLeftTime=now;
  if(Math.abs(lastLeftTime-lastRightTime)<150 && !cheatActive){
    cheatActive=true; lives=2; cheatToastText='Cheat Mode: 2 Lives'; cheatToastTimer=2.0;
  }
});
btnRight.addEventListener('click',()=>{
  if(mode!=='game') return;
  const now=performance.now(); if(currentLane<2) currentLane++; lastRightTime=now;
  if(Math.abs(lastLeftTime-lastRightTime)<150 && !cheatActive){
    cheatActive=true; lives=2; cheatToastText='Cheat Mode: 2 Lives'; cheatToastTimer=2.0;
  }
});

/* ========================= Cat Drawing ========================= */
function drawCat(x,y,w,h){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle='#d9822c';
  ctx.beginPath(); ctx.ellipse(0,0,w*0.7,h*0.9,0,0,Math.PI*2); ctx.fill();
  const hr=w*0.45; const hy=-h*0.75;
  ctx.fillStyle='#d9822c'; ctx.beginPath(); ctx.arc(0,hy,hr,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#c36b1f';
  ctx.beginPath(); ctx.moveTo(-hr*0.6,hy-hr*0.2); ctx.lineTo(-hr*0.9,hy-hr*0.9); ctx.lineTo(-hr*0.2,hy-hr*0.7); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(hr*0.6,hy-hr*0.2); ctx.lineTo(hr*0.9,hy-hr*0.9); ctx.lineTo(hr*0.2,hy-hr*0.7); ctx.closePath(); ctx.fill();
  ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(-hr*0.3,hy,hr*0.25,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(hr*0.3,hy,hr*0.25,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(-hr*0.3,hy,hr*0.12,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(hr*0.3,hy,hr*0.12,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#ff9999'; ctx.beginPath(); ctx.arc(0,hy+hr*0.25,hr*0.18,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#fff'; ctx.lineWidth=1.2;
  ctx.beginPath(); ctx.moveTo(-hr*0.2,hy+hr*0.25); ctx.lineTo(-hr*1.0,hy+hr*0.15); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(hr*0.2,hy+hr*0.25); ctx.lineTo(hr*1.0,hy+hr*0.15); ctx.stroke();
  ctx.strokeStyle='#d9822c'; ctx.lineWidth=8;
  ctx.beginPath(); ctx.moveTo(-w*0.6,0); ctx.quadraticCurveTo(-w*1.2,-h*0.6,-w*0.5,-h*1.0); ctx.stroke();
  ctx.restore();
}

/* ========================= Mouse (front screen) ========================= */
function drawFrontMouseGrey(x,y,s,groundY){
  ctx.fillStyle='#b5b7bb';
  ctx.beginPath(); ctx.ellipse(x,y,12*s,7*s,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(x+9*s,y-1*s,6*s,5*s,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(x+11*s,y-2*s,1.4*s,0,Math.PI*2); ctx.fill();
  // feet inline with groundY
  ctx.strokeStyle='#8f9096'; ctx.lineWidth=2*s;
  ctx.beginPath(); ctx.moveTo(x-4*s, groundY); ctx.lineTo(x-2*s, groundY); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x+6*s, groundY); ctx.lineTo(x+8*s, groundY); ctx.stroke();
}

/* ========================= Pickup Logic ========================= */
function collectPickup(p){
  if(p.type==='dash'){
    startDash();
    lives=Math.min(2,lives+1);
    cheatToastText='Dash + Shield +1'; cheatToastTimer=2.0;
  }
  else if(p.type==='chicken'){
    fuel=Math.min(100,fuel+25);
    score+=p.golden?30:15;
    if(p.golden){ lives=Math.min(2,lives+1); cheatToastText='Shield +1'; cheatToastTimer=2.0; }
  }
  else if(p.type==='mouse'){ fuel=Math.min(100,fuel+(p.golden?20:10)); score+=(p.golden?10:3); }
  else if(p.type==='bird'){ fuel=Math.min(100,fuel+(p.golden?20:10)); score+=(p.golden?10:3); }
  else if(p.type==='lizard'){ fuel=Math.min(100,fuel+(p.golden?22:12)); score+=(p.golden?12:5); }
}

/* ========================= Game Flow ========================= */
function startGame(){ enemies=[]; pickups=[]; score=0; fuel=100; meters=0; lives=1; cheatActive=false; mode='game'; }
function endGame(){ mode='front'; lastScore=Math.round(score); const n=getPlayerName(); submitBestIfHigher(n,lastScore); }

/* ========================= Front Screen ========================= */
let frontRunnerX=0;
function drawFront(){
  ctx.clearRect(0,0,W,H);
  // background sky
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#ff6b9e'); g.addColorStop(.55,'#ff8a4d'); g.addColorStop(1,'#f3c36a');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  ctx.fillStyle='#fff'; ctx.font='bold 48px sans-serif'; ctx.textAlign='center';
  ctx.fillText("GINGERBOLT",W/2,80);

  // ground alignment
  const groundY=H*0.92;
  const pathW=W*0.86, pathL=(W-pathW)/2;
  frontRunnerX=(frontRunnerX+2)%(pathW+160);

  const mouseX=pathL-80+frontRunnerX;
  drawFrontMouseGrey(mouseX,groundY-10,1.2,groundY);

  const catX=mouseX-120;
  drawCat(catX,groundY-10,40,50);
}

/* ========================= Loop ========================= */
function loop(){ if(mode==='front'){ drawFront(); } else { ctx.clearRect(0,0,W,H); drawCat(lanesX()[currentLane],H-120,40,50);} requestAnimationFrame(loop); }
loop();
  </script>
</body>
</html>
