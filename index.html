<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#12161c" />
  <title>Gingerbolt</title>
  <style>
    :root{
      --pink:#ff4081; --pink-hi:#ff6fa3; --indigo:#5865F2; --bg:#12161c;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; height:100dvh; overflow:hidden; }
    canvas { display:block; margin:0 auto; background:#000; touch-action:none; backface-visibility:hidden; -webkit-backface-visibility:hidden; transform:translateZ(0); will-change:transform; }

    /* Front & Menu buttons */
    .stack { position:fixed; display:none; z-index:9; left:50%; transform:translateX(-50%); pointer-events:auto; width:min(92vw,520px); }
    #frontStack { top: 46%; }  /* raised so text + leaderboard fit */
    #menuStack  { top: 78%; }
    .stack .buttons { display:flex; flex-direction:column; gap:12px; align-items:center; }
    .btn { border:0; border-radius:14px; padding:12px 18px; font-size:16px; color:#fff; box-shadow:0 8px 22px rgba(0,0,0,.35); -webkit-tap-highlight-color:transparent; }
    .btn:active { transform:translateY(1px) scale(.98); }
    .btn-primary { background:linear-gradient(180deg,var(--pink-hi) 0%, var(--pink) 100%); font-weight:800; min-width:200px; }
    .btn-indigo  { background:var(--indigo); min-width:200px; }

    /* On-screen arrows (in game only) */
    .controls { position:fixed; inset:0; pointer-events:none; z-index:10; display:none; }
    .laneBtn  { position:absolute; width:80px; height:80px; border:none; border-radius:20px; background:rgba(0,0,0,.35); color:#fff; font-size:28px; box-shadow:0 6px 18px rgba(0,0,0,.35); -webkit-tap-highlight-color:transparent; touch-action:manipulation; pointer-events:auto; transform:translate(-50%, -50%); }
    .laneBtn:active { transform:translate(-50%, -50%) scale(.96); }
    @media (min-width:900px){ .controls{ display:none !important; } }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <!-- FRONT -->
  <div id="frontStack" class="stack">
    <div class="buttons">
      <button id="playBtn" class="btn btn-primary" type="button">Play</button>
      <button id="frontChangeNameBtn" class="btn btn-indigo" type="button">Change Name</button>
    </div>
  </div>

  <!-- MENU -->
  <div id="menuStack" class="stack">
    <div class="buttons">
      <button id="startBtn" class="btn btn-primary" type="button">Start Game</button>
    </div>
  </div>

  <!-- In-game lane arrows -->
  <div id="controls" class="controls">
    <button id="btnLane1" class="laneBtn" aria-label="Move left">◀</button>
    <button id="btnLane3" class="laneBtn" aria-label="Move right">▶</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  /* ========================= Supabase (Leaderboard) ========================= */
  const SUPABASE_URL = 'https://fvcvrhaxxpsientgggnx.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2Y3ZyaGF4eHBzaWVudGdnZ254Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODczMzYsImV4cCI6MjA3MTY2MzMzNn0.5wTxwGVJDa3gnS61gaDq00xSFGUMEQ0Pda6tJo4VK-A';
  const TABLE_NAME = 'highscores';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const NAME_KEY = 'catdash_name';
  function getPlayerName(){ let n = localStorage.getItem(NAME_KEY); if(!n){ n = prompt('Enter player name (3–12 chars):','CAT')||'CAT'; n=n.trim().slice(0,12); if(n.length<3) n=(n+'CAT').slice(0,3); localStorage.setItem(NAME_KEY,n);} return n; }
  let globalBoard = []; let lastBoardFetch = 0;
  async function fetchGlobalTop(limit=20){ try{ const {data,error}=await supa.from(TABLE_NAME).select('name,score,updated_at').order('score',{ascending:false}).limit(limit); if(error) throw error; globalBoard=Array.isArray(data)?data:[]; lastBoardFetch=performance.now(); }catch(e){ console.warn('LB fetch error',e.message||e); } }
  async function submitBestIfHigher(name,score){ try{ const {data:existing,error:e1}=await supa.from(TABLE_NAME).select('score').eq('name',name).single(); const prev=Number(existing?.score||0); if(!e1 && score<=prev) return false; const payload={name,score,updated_at:new Date().toISOString()}; const {error:e2}=await supa.from(TABLE_NAME).upsert(payload,{onConflict:'name'}); if(e2) throw e2; fetchGlobalTop(20); return true; }catch(e){ console.warn('LB submit error',e.message||e); return false; } }

  /* ========================= Canvas / viewport ========================= */
  const canvas=document.getElementById('gameCanvas');
  const ctx=canvas.getContext('2d',{alpha:false, desynchronized:true});
  function getViewportSize(){ const vv=window.visualViewport; if(vv) return {w:Math.floor(vv.width), h:Math.floor(vv.height)}; return {w:Math.floor(window.innerWidth), h:Math.floor(window.innerHeight)}; }
  let {w:W,h:H}=getViewportSize(); let DPR=1;
  function resizeCanvas(){ DPR=Math.max(1,Math.min(3,window.devicePixelRatio||1)); canvas.style.width=W+'px'; canvas.style.height=H+'px'; canvas.width=Math.floor(W*DPR); canvas.height=Math.floor(H*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high'; }
  resizeCanvas();
  function handleResize(){ const v=getViewportSize(); W=v.w; H=v.h; resizeCanvas(); positionButtons(); initFlowerSpots(); initPetals(); }
  window.addEventListener('resize',handleResize,{passive:true});
  if(window.visualViewport){ visualViewport.addEventListener('resize',handleResize,{passive:true}); visualViewport.addEventListener('scroll',handleResize,{passive:true}); }
  function lanesX(){ return [W/4, W/2, (3*W)/4]; }

  /* ========================= Controls ========================= */
  const controls=document.getElementById('controls');
  const CAT_Y_LIFT=-30; const BUTTON_Y_OFFSET=50;
  function positionButtons(){
    const btn1=document.getElementById('btnLane1'); const btn3=document.getElementById('btnLane3');
    const lx=lanesX();
    const baseY=H-Math.min(120,H*.12);
    const y=Math.min(H-10, baseY+BUTTON_Y_OFFSET);
    btn1.style.left=lx[0]+'px'; btn1.style.top=y+'px';
    btn3.style.left=lx[2]+'px'; btn3.style.top=y+'px';
  }
  positionButtons();

  /* ========================= Game state ========================= */
  let mode='front', currentLane=1, enemies=[], pickups=[], particles=[];
  let score=0, fuel=100, meters=0;
  let spawnTimer=0, last=undefined, graceTimer=.75, restartDelay=0;
  let roadSpeed=226, maxSpeed=704, baseAccel=.6, slipTimer=0, slipOffset=0;
  let btn1Down=false, btn3Down=false, cheatArmTimerMs=0, cheatCharges=0, cheatRearmLock=false;
  const CHEAT_HOLD_TIME_MS=50;
  let cheatToastTimer=0, cheatToastText='';
  let dashActive=false, dashTimer=0;
  const DASH_DURATION=8.0, DASH_SPEED_MUL=1.30, DASH_SCORE_MUL=2;

  /* ========================= Visual helpers ========================= */
  function withShadow(color='rgba(0,0,0,.35)', blur=8, oy=3, fn){ ctx.save(); ctx.shadowColor=color; ctx.shadowBlur=blur; ctx.shadowOffsetX=0; ctx.shadowOffsetY=oy; fn(); ctx.restore(); }
  function strokeAround(color='rgba(0,0,0,.35)', lw=2, fn){ ctx.save(); ctx.lineWidth=lw; ctx.strokeStyle=color; fn(); ctx.stroke(); ctx.restore(); }

  /* ========================= Background (game scenes) ========================= */
  const FLOWER_SEG_METERS=400; const FLOWER_COLORS=['#ffec99','#ffd6e7','#c0ebff','#c3fda7','#ffd8a8','#eebefa','#b2f2bb']; const flowerSpots=[];
  function initFlowerSpots(){ flowerSpots.length=0; const count=Math.max(80,Math.floor(W*H/11000)); for(let i=0;i<count;i++){ flowerSpots.push({x:Math.random()*W,y:Math.random()*H,r:1.2+Math.random()*1.4,rot:Math.random()*Math.PI*2,stem:Math.random()<.8}); } }
  initFlowerSpots();
  function drawBloom(x,y,s,color,rot){ ctx.save(); ctx.translate(x,y); ctx.rotate(rot); const pr=s*2.1, cr=s*1.1; ctx.fillStyle=color; for(let i=0;i<5;i++){ const a=(i/5)*Math.PI*2; ctx.beginPath(); ctx.ellipse(Math.cos(a)*s*1.1, Math.sin(a)*s*1.1, pr*.55, pr*.35, a, 0, Math.PI*2); ctx.fill(); } const g=ctx.createRadialGradient(0,0,0,0,0,cr); g.addColorStop(0,'rgba(255,255,220,.95)'); g.addColorStop(1,'rgba(255,255,220,.2)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,cr,0,Math.PI*2); ctx.fill(); ctx.restore(); }
  function drawBackground(){ const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#64b24a'); g.addColorStop(1,'#4d9c3b'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); }

  /* ========================= Obstacles, pickups, cat, HUD ========================= */
  const CAT_W=22, CAT_H=34;
  function drawCat(x,y,w,h){ withShadow('rgba(0,0,0,.35)',12,5,()=>{ ctx.fillStyle='#d07a2b'; ctx.beginPath(); ctx.ellipse(x,y,w/1.55,h/1.12,0,0,Math.PI*2); ctx.fill(); }); }

  /* ========================= Anime petals ========================= */
  const PETAL_COUNT = 36;
  const petals = [];
  function initPetals(){ petals.length=0; for(let i=0;i<PETAL_COUNT;i++){ petals.push({x:Math.random()*W,y:Math.random()*H,r:4+Math.random()*4,v:12+Math.random()*24,sway:Math.random()*2+1.2,a:Math.random()*Math.PI*2}); } }
  initPetals();
  function updatePetals(dt){ const speedMul=dashActive?1.8:1.0; const swirlMul=dashActive?1.8:1.0; for(const p of petals){ p.a+=dt*1.6*swirlMul; p.x+=Math.sin(p.a)*p.sway*swirlMul; p.y+=p.v*dt*speedMul; if(p.y>H+20){ p.y=-20; p.x=Math.random()*W; } } }
  function drawPetals(){ ctx.save(); ctx.globalAlpha=dashActive?0.9:0.7; for(const p of petals){ ctx.fillStyle='#ffb3c7'; ctx.beginPath(); ctx.ellipse(p.x,p.y,p.r*0.9,p.r*0.6,0,0,Math.PI*2); ctx.fill(); } ctx.restore(); }
  function drawPetalVortex(cx,cy){ if(!dashActive) return; ctx.save(); ctx.globalCompositeOperation='lighter'; for(let i=0;i<10;i++){ const t=performance.now()/600+i*0.3; const r=26+i*6; const ang=t*4+i*0.7; const x=cx+Math.cos(ang)*r; const y=cy+Math.sin(ang)*r*0.6; ctx.fillStyle='rgba(255,200,220,0.7)'; ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill(); } ctx.restore(); }

  /* ========================= Dash overlay ========================= */
  function drawDashOverlay(){ if(!dashActive) return; ctx.save(); ctx.globalAlpha=0.18; ctx.fillStyle='#ff9800'; ctx.fillRect(0,0,W,H); ctx.restore(); }

  /* ========================= HUD & Leaderboard ========================= */
  function drawHUD(){ ctx.fillStyle='#fff'; ctx.font='16px system-ui, sans-serif'; ctx.fillText('Score: '+Math.round(score),10,22); ctx.fillText('Energy: '+Math.round(fuel),10,42); }
  function drawGlobalBoard(x,y,maxRows=10){ ctx.fillStyle='#fff'; ctx.font='14px monospace'; ctx.fillText('Global Top 20',x,y); if(!globalBoard.length){ ctx.fillText('Loading...',x,y+20); return; } for(let i=0;i<Math.min(maxRows,globalBoard.length);i++){ const e=globalBoard[i]; const line=`${i+1}. ${(e.name||'???').slice(0,10)} ${e.score}`; ctx.fillText(line,x,y+20+i*16); } }

  /* ========================= Front screen ========================= */
  const CAT_MASCOT_NAME='Gingerbolt';
  let frontT=0;
  function drawFront(){ ctx.fillStyle='linear-gradient(#ff3d7f,#ff7a3d)'; ctx.fillRect(0,0,W,H); const title='GINGERBOLT'; ctx.save(); ctx.font=`${Math.floor(W*0.13)}px Impact`; ctx.textAlign='center'; ctx.fillStyle='#2a0a0a'; ctx.fillText(title,W/2,H*0.2); ctx.restore(); ctx.font='18px system-ui'; ctx.fillStyle='#fff'; ctx.fillText('Join Gingerbolt on his electrifying dash to glory!',W/2,H*0.26); ctx.fillText('Help Gingerbolt weave past trees and mud, snag snacks, and charge ⚡ to dash.',W/2,H*0.3); ctx.fillText('Aim: stay alive, collect food, keep energy up, and set a high score.',W/2,H*0.34); drawGlobalBoard(18,H*0.55,10); }

  /* ========================= Flow ========================= */
  const PLAYER_Y=()=>Math.min(H-190,H*0.64+CAT_Y_LIFT);
  function update(dt){ updatePetals(dt); }
  function draw(){ if(mode==='front'){ frontT+=.016; drawFront(); return; } drawBackground(); drawPetals(); drawCat(lanesX()[currentLane]+slipOffset,PLAYER_Y(),CAT_W,CAT_H); drawPetalVortex(lanesX()[currentLane]+slipOffset,PLAYER_Y()); drawHUD(); drawDashOverlay(); }
  function endGame(){ mode='menu'; }
  function resetGame(){ score=0; fuel=100; meters=0; enemies=[]; pickups=[]; particles=[]; initFlowerSpots(); initPetals(); }
  function startGame(){ resetGame(); mode='game'; }
  function loop(ts){ if(last===undefined) last=ts; let dt=(ts-last)/1000; last=ts; update(dt); draw(); requestAnimationFrame(loop); }

  /* ========================= Inputs ========================= */
  const menuStack=document.getElementById('menuStack'); const startBtn=document.getElementById('startBtn'); const frontStack=document.getElementById('frontStack'); const playBtn=document.getElementById('playBtn'); const frontChangeNameBtn=document.getElementById('frontChangeNameBtn');
  playBtn.addEventListener('click',()=>{ startGame(); }); startBtn.addEventListener('click',()=>{ startGame(); }); frontChangeNameBtn.addEventListener('click',()=>{ localStorage.removeItem(NAME_KEY); getPlayerName(); });

  /* Boot */
  fetchGlobalTop(20);
  requestAnimationFrame(loop);
  </script>
</body>
</html>
