<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CatDash</title>
  <style>
    :root {
      --bg:#0d0f14;
      --panel:#12151c;
      --card:#161a22;
      --accent:#ffc83d;
      --accent2:#8ad0ff;
      --text:#e9eef7;
      --muted:#94a3b8;
      --glass:rgba(22,26,34,.65);

      /* hero colours */
      --heroTop:#ff7f7f;
      --heroMid:#ff7a45;
      --heroLow:#e4572e;
      --heroFloor:#0f1320;
      --sun:#ffd27a;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 600px at 50% 10%, #131827 0%, var(--bg) 60%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overflow: hidden;
    }
    /* Full screen responsive layout */
    .shell {
      position: fixed;
      inset: 0;
      display: grid;
      grid-template-columns: 1fr minmax(280px, 360px);
      grid-template-rows: 100%;
      gap: 16px;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
    }
    @media (max-width: 900px) {
      .shell { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
    }
    .playfield {
      position: relative;
      border-radius: 20px;
      background: linear-gradient(180deg, #172033 0%, #0f1320 100%);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      overflow: hidden;
    }
    canvas { display:block; width:100%; height:100%; }

    .sidebar {
      background: var(--panel);
      border-radius: 20px;
      padding: 16px;
      display:flex;flex-direction:column;gap:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .brandRow { display:flex; align-items:center; justify-content:space-between; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px; }
    .brand svg { width:28px; height:28px; }
    .pill { padding:.25rem .6rem; border-radius:999px; background:#1f2430; color:var(--muted); font-size:.85rem; }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .card h3 { margin:0 0 8px 0; font-size:1rem; color:#cfe0ff; }

    .lb-list { margin:0; padding:0; list-style:none; }
    .lb-list li { display:flex; align-items:center; justify-content:space-between; padding:10px 8px; border-radius:10px; }
    .lb-list li:nth-child(odd){ background:#1a2030; }
    .lb-name { font-weight:600; }
    .lb-score { color:var(--accent); font-variant-numeric: tabular-nums; }

    /* Start overlay kept away from leaderboard */
    .overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(900px 500px at 50% 30%, rgba(20,24,38,.9), rgba(10,12,18,.95));
      z-index: 5;
    }
    .overlay-inner {
      position:relative;
      width:min(900px, 92vw);
      display:grid; grid-template-columns: 1.2fr 1fr; gap:20px; align-items:center;
      padding:20px; border-radius:20px; background:var(--glass); backdrop-filter: blur(10px);
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      overflow:hidden;
    }
    @media (max-width: 900px){
      .overlay-inner{ grid-template-columns: 1fr; }
    }

    /* hero background behind the content */
    .hero-bg{
      position:absolute; inset:0; pointer-events:none;
      background:linear-gradient(180deg,var(--heroTop) 0%, var(--heroMid) 40%, var(--heroLow) 70%, var(--heroFloor) 100%);
    }
    .sun, .streaks{ position:absolute; left:50%; top:62%; transform:translate(-50%,-50%); }
    .sun{
      width:clamp(220px,40vw,520px); height:clamp(220px,40vw,520px); border-radius:50%;
      background:radial-gradient(closest-side,var(--sun) 0%,#ffb84a 60%,#ff9a1a 100%);
      box-shadow:0 0 80px 30px #ffb84a44, 0 0 180px 80px #ff9a1a22;
      filter:blur(.2px);
    }
    .streaks{
      width:2200px; height:2200px; border-radius:50%;
      background:repeating-conic-gradient(from 0deg, rgba(255,210,122,.45) 0deg 2deg, transparent 2deg 6deg);
      mask-image:radial-gradient(circle at 50% 50%, transparent 0 18%, black 20% 100%);
      -webkit-mask-image:radial-gradient(circle at 50% 50%, transparent 0 18%, black 20% 100%);
      filter:blur(.2px);
    }

    .hero { position:relative; z-index:1; }
    .title {
      font-size: clamp(36px, 6vw, 56px);
      font-weight: 900;
      line-height: 1.05;
      margin: 0 0 8px 0;
      letter-spacing: .5px;
      text-align:center;
      text-shadow:0 3px 0 #ffffff, 0 10px 20px rgba(0,0,0,.45);
      color:#0f0a09;
    }
    .subtitle { color: var(--muted); margin:0 0 18px 0; text-align:center; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
    .input { background:#0f1320; color:var(--text); border:1px solid #283048; border-radius:12px; padding:12px 14px; font-size:1rem; flex:1; min-width: 180px; }
    .btn { background:var(--accent); color:#2a2100; border:0; border-radius:12px; padding:12px 16px; font-weight:800; font-size:1rem; cursor:pointer; box-shadow: 0 8px 20px rgba(255,200,61,.3); }
    .btn:active { transform: translateY(1px); }

    /* Cute cat SVG container */
    .mascot-wrap { position:relative; aspect-ratio: 16/10; width:100%; z-index:1; }
    .hint { font-size:.9rem; color:var(--muted); margin-top:10px; text-align:center; }

    /* Hide any arrow button the old build might render */
    .arrow, .arrow-button, .left-arrow, .right-arrow { display:none !important; }
  </style>
</head>
<body>
  <div class="shell">
    <section class="playfield" id="playfield">
      <canvas id="game"></canvas>

      <!-- Start overlay lives only on the main screen and never during play -->
      <div class="overlay" id="startOverlay" role="dialog" aria-modal="true">
        <div class="overlay-inner">
          <!-- anime sun + streaks background -->
          <div class="hero-bg" aria-hidden="true">
            <div class="streaks"></div>
            <div class="sun"></div>
          </div>

          <div class="hero">
            <h1 class="title">CatDash</h1>
            <p class="subtitle">Quick paw reflex game. Catch the mouse, climb the board.</p>
            <div class="controls">
              <input id="playerName" class="input" placeholder="Your name" autocomplete="name" />
              <button id="startBtn" class="btn">Start</button>
            </div>
            <p class="hint">Tip: works on phones. Full screen layout.</p>
          </div>

          <div>
            <!-- Simple friendly cat illustration as inline SVG so no external assets needed -->
            <div class="mascot-wrap">
              <svg id="catSvg" viewBox="0 0 320 200" width="100%" height="100%" aria-label="Cartoon cat chasing a mouse">
                <defs>
                  <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                    <feDropShadow dx="0" dy="3" stdDeviation="6" flood-color="#000" flood-opacity="0.35" />
                  </filter>
                </defs>
                <!-- ground -->
                <ellipse cx="160" cy="180" rx="120" ry="14" fill="#0b0e15" />
                <!-- tail -->
                <path d="M240 120c35 -10 45 20 32 30c-8 7 -16 2 -22 -5" fill="none" stroke="#ffcf7d" stroke-width="10" stroke-linecap="round"/>
                <!-- body -->
                <ellipse cx="200" cy="120" rx="55" ry="40" fill="#ffcf7d" filter="url(#shadow)"/>
                <!-- back leg -->
                <ellipse cx="170" cy="150" rx="22" ry="14" fill="#ffcf7d"/>
                <!-- front leg -->
                <ellipse cx="230" cy="148" rx="22" ry="14" fill="#ffcf7d"/>
                <!-- head -->
                <circle cx="145" cy="110" r="28" fill="#ffcf7d"/>
                <!-- ears -->
                <path d="M130 86 l-12 -18 l-8 20 z" fill="#ffcf7d"/>
                <path d="M158 86 l12 -18 l8 20 z" fill="#ffcf7d"/>
                <!-- face -->
                <circle cx="137" cy="112" r="4" fill="#333"/>
                <circle cx="154" cy="112" r="4" fill="#333"/>
                <path d="M140 120 q6 6 12 0" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round"/>
                <path d="M125 116 q-14 4 -22 0" stroke="#333" stroke-width="2" fill="none" stroke-linecap="round"/>
                <path d="M166 116 q14 4 22 0" stroke="#333" stroke-width="2" fill="none" stroke-linecap="round"/>
                <!-- tiny mouse -->
                <g id="mouse" transform="translate(40,158)">
                  <ellipse cx="12" cy="6" rx="12" ry="8" fill="#9aa6b2"/>
                  <circle cx="2" cy="6" r="4" fill="#9aa6b2"/>
                  <circle cx="0" cy="6" r="1.5" fill="#222"/>
                  <path d="M22 8 q10 6 18 0" stroke="#9aa6b2" stroke-width="2" fill="none"/>
                </g>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </section>

    <aside class="sidebar" aria-label="Leaderboard and info">
      <div class="brandRow">
        <div class="brand" aria-label="CatDash brand">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="28" fill="#0e1322" stroke="#2b3350" stroke-width="4"/>
            <path d="M22 28c0-6 10-6 10 0" stroke="#ffc83d" stroke-width="3"/>
            <circle cx="24" cy="24" r="2" fill="#ffc83d"/>
            <circle cx="34" cy="24" r="2" fill="#ffc83d"/>
          </svg>
          <span>CatDash</span>
        </div>
        <span class="pill" id="status">Ready</span>
      </div>

      <div class="card">
        <h3>Leaderboard</h3>
        <ol class="lb-list" id="leaderboard">
          <!-- Filled by JS -->
        </ol>
      </div>

      <div class="card">
        <h3>Controls</h3>
        <div style="color:var(--muted); font-size:.95rem; line-height:1.4;">
          Tap or click to pounce. Catch streaks for higher scores.
        </div>
      </div>
    </aside>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ===== Supabase setup. Paste your details. ===== */
    const SUPABASE_URL  = 'https://YOUR-PROJECT.supabase.co';   // ← replace
    const SUPABASE_ANON = 'YOUR-ANON-KEY';                      // ← replace
    const supaEnabled = SUPABASE_URL.includes('supabase.co') && !SUPABASE_ANON.startsWith('YOUR-');
    const supabase = supaEnabled ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;
    // expected table: scores(name text, score int, created_at timestamptz default now())

    // Local fallback store (kept from your build)
    const storeKey = 'catdash_lb_v2';
    const loadLBLocal = () => JSON.parse(localStorage.getItem(storeKey) || '[]');
    const saveLBLocal = (arr) => localStorage.setItem(storeKey, JSON.stringify(arr.slice(0,50)));

    // Populate demo leaderboard if empty for local fallback
    const demo = [
      { name: 'Mittens', score: 1240 },
      { name: 'Whiskers', score: 980 },
      { name: 'Kaye', score: 770 },
      { name: 'Chris', score: 720 },
      { name: 'Paws', score: 540 }
    ];
    if (!supaEnabled && loadLBLocal().length === 0) saveLBLocal(demo);

    function escapeHtml(x){return (x+'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    async function loadLB(){
      if (!supaEnabled){
        return loadLBLocal().sort((a,b)=>b.score-a.score).slice(0,20);
      }
      const { data, error } = await supabase
        .from('scores')
        .select('name, score, created_at')
        .order('score', { ascending:false })
        .limit(20);
      if (error){ console.error(error); return []; }
      return data || [];
    }

    async function saveScoreGlobal(name, score){
      if (!supaEnabled){
        const board = loadLBLocal(); board.push({ name, score }); saveLBLocal(board); return;
      }
      const { error } = await supabase.from('scores').insert({ name, score });
      if (error) console.error(error);
    }

    async function renderLB(){
      const el = document.getElementById('leaderboard');
      el.innerHTML = '<li><span class="lb-name">Loading…</span></li>';
      const rows = await loadLB();
      if (!rows || rows.length===0){
        el.innerHTML = '<li><span class="lb-name">Be the first to set a score</span></li>';
        return;
      }
      el.innerHTML = rows
        .map((row,i)=>{
          const name = escapeHtml(row.name || 'Anon');
          const score = row.score ?? 0;
          return `<li><span class="lb-name">${i+1}. ${name}</span><span class="lb-score">${score}</span></li>`;
        }).join('');
    }
    renderLB();

    if (supaEnabled){
      try{
        supabase.channel('scores-change')
          .on('postgres_changes', { event:'*', schema:'public', table:'scores' }, renderLB)
          .subscribe();
      }catch(e){ /* ignore if not permitted */ }
    }

    // Full screen canvas game stub (kept lightweight) -----------------------
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    function resize(){
      const rect = document.getElementById('playfield').getBoundingClientRect();
      canvas.width = Math.floor(rect.width);
      canvas.height = Math.floor(rect.height);
    }
    new ResizeObserver(resize).observe(document.getElementById('playfield'));
    window.addEventListener('orientationchange', ()=> setTimeout(resize, 200));
    resize();

    // Game state
    let running = false;
    let score = 0;
    let player = { x: 120, y: 120, r: 26 };
    let target = { x: 200, y: 120, r: 12 };

    // Lift cat a bit so it is not off the bottom of the screen
    function initialCatY(){
      return Math.max(60, canvas.height * 0.65);
    }

    function reset(){
      score = 0;
      player.x = canvas.width * 0.3;
      player.y = initialCatY();
      jitterTarget();
    }

    function jitterTarget(){
      target.x = Math.random() * (canvas.width - 80) + 40;
      target.y = Math.random() * (canvas.height - 120) + 60; // keep away from edges and bottom
    }

    function drawCat(cx, cy){
      // very simple cat made from circles so we avoid external images
      const scale = 1;
      ctx.save();
      ctx.translate(cx, cy);
      ctx.scale(scale, scale);
      // body
      ctx.fillStyle = '#ffcf7d';
      ctx.beginPath(); ctx.ellipse(0, 0, 40, 26, 0, 0, Math.PI*2); ctx.fill();
      // head
      ctx.beginPath(); ctx.arc(-38, -10, 18, 0, Math.PI*2); ctx.fill();
      // ears
      ctx.beginPath(); ctx.moveTo(-50,-20); ctx.lineTo(-62,-36); ctx.lineTo(-56,-16); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(-26,-20); ctx.lineTo(-14,-36); ctx.lineTo(-20,-16); ctx.closePath(); ctx.fill();
      // legs
      ctx.beginPath(); ctx.ellipse(-12, 16, 12, 8, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(18, 14, 12, 8, 0, 0, Math.PI*2); ctx.fill();
      // tail
      ctx.strokeStyle = '#ffcf7d'; ctx.lineWidth = 8; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(22, -6); ctx.quadraticCurveTo(50,-18, 46, 12); ctx.stroke();
      // face
      ctx.fillStyle = '#333';
      ctx.beginPath(); ctx.arc(-44,-12,2,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(-32,-12,2,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(-42,-6); ctx.quadraticCurveTo(-38,-2, -34,-6); ctx.stroke();
      ctx.restore();
    }

    function drawMouse(mx, my){
      ctx.save(); ctx.translate(mx, my);
      ctx.fillStyle = '#9aa6b2';
      ctx.beginPath(); ctx.ellipse(0, 0, 10, 7, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(-9, 0, 3, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#222'; ctx.beginPath(); ctx.arc(-12, 0, 1.2, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#9aa6b2'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(8, 2); ctx.quadraticCurveTo(16, 8, 24, 2); ctx.stroke();
      ctx.restore();
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width, canvas.height);
      // background stars
      for(let i=0;i<40;i++){
        const x = (i*97 % canvas.width);
        const y = (i*i*29 % canvas.height);
        ctx.globalAlpha = .08 + (i%5)*.04; ctx.fillStyle = '#cfe0ff';
        ctx.fillRect(x, y, 2, 2);
      }
      ctx.globalAlpha = 1;

      // ground
      ctx.fillStyle = '#0b0e15';
      ctx.beginPath(); ctx.ellipse(canvas.width/2, canvas.height-18, canvas.width*0.35, 10, 0, 0, Math.PI*2); ctx.fill();

      // entities
      drawCat(player.x, player.y);
      drawMouse(target.x, target.y);

      // score
      ctx.fillStyle = 'rgba(255,255,255,.9)';
      ctx.font = '700 20px system-ui, -apple-system, Segoe UI';
      ctx.fillText('Score ' + score, 16, 28);
    }

    // Input
    function handleInput(evt){
      if (!running) return;
      const rect = canvas.getBoundingClientRect();
      const x = (evt.clientX ?? evt.touches?.[0]?.clientX) - rect.left;
      const y = (evt.clientY ?? evt.touches?.[0]?.clientY) - rect.top;
      // move the cat toward the tap quickly
      player.x += (x - player.x) * 0.8;
      player.y += (y - player.y) * 0.8;
      // hit test
      const dx = player.x - target.x;
      const dy = player.y - target.y;
      const d2 = dx*dx + dy*dy;
      if (d2 < (player.r + target.r) * (player.r + target.r)){
        score += 50; // basic points
        document.getElementById('status').textContent = 'Nice catch!';
        jitterTarget();
      } else {
        score = Math.max(0, score - 5);
        document.getElementById('status').textContent = 'Missed';
      }
    }

    canvas.addEventListener('pointerdown', handleInput, { passive: true });
    canvas.addEventListener('touchstart', handleInput, { passive: true });

    // Game loop
    function loop(){
      if (running){
        // gentle mouse drift
        target.x += Math.sin(performance.now()/500) * 0.6;
        target.y += Math.cos(performance.now()/700) * 0.4;
        // keep inside bounds
        target.x = Math.max(20, Math.min(canvas.width-20, target.x));
        target.y = Math.max(40, Math.min(canvas.height-40, target.y));
      }
      draw();
      requestAnimationFrame(loop);
    }
    loop();

    // Start logic, name input only on main screen
    const overlay = document.getElementById('startOverlay');
    const startBtn = document.getElementById('startBtn');
    const nameInput = document.getElementById('playerName');

    startBtn.addEventListener('click', ()=>{
      const name = (nameInput.value || '').trim() || 'Cat';
      overlay.style.display = 'none';
      document.getElementById('status').textContent = 'Playing as ' + name;
      reset();
      running = true;
    });

    async function endGame(){
      running = false;
      const name = (nameInput.value || '').trim() || 'Cat';
      await saveScoreGlobal(name, score);
      await renderLB();
      document.getElementById('status').textContent = 'Finished at ' + score;
      overlay.style.display = 'flex';
    }

    // Expose endGame so you can call it from any game condition
    window.CATDASH = { endGame };

    // Small animated wiggle for SVG cat on the start screen
    const svg = document.getElementById('catSvg');
    let t0 = performance.now();
    function wiggle(){
      const t = (performance.now()-t0)/1000;
      const amp = 3;
      const y = Math.sin(t*2) * amp;
      svg.style.transform = `translateY(${y}px)`;
      requestAnimationFrame(wiggle);
    }
    wiggle();
  </script>
</body>
</html>
