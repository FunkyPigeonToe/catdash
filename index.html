<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Gingerbolt</title>
<style>
  :root { --bg:#12161c; --pink:#ff4081; --pink-hi:#ff6fa3; --indigo:#5865F2; }
  html, body {
    margin:0; padding:0; background:#333; color:#fff;
    font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    height:100dvh; overflow:hidden;
  }
  canvas {
    display:block; margin:0 auto; background:#6dbb4a; touch-action:none;
    backface-visibility:hidden; -webkit-backface-visibility:hidden; transform:translateZ(0); will-change:transform;
  }
  /* On-screen arrows */
  .controls { position:fixed; inset:0; pointer-events:none; z-index:10; }
  .controls[hidden] { display:none; }
  .laneBtn {
    position:absolute; width:80px; height:80px; border:none; border-radius:20px;
    background:rgba(0,0,0,.35); color:#fff; font-size:28px; box-shadow:0 6px 18px rgba(0,0,0,.35);
    pointer-events:auto; transform:translate(-50%, -50%);
  }
  .laneBtn:active { transform:translate(-50%, -50%) scale(.96); }
  @media (min-width:900px){ .controls{ display:none !important; } }

  /* Front screen buttons */
  #frontButtons {
    position: absolute; left: 50%; transform: translateX(-50%);
    top: 68%; display: flex; flex-direction: column; gap: 12px;
    z-index: 20;
  }
  .btn {
    border: 0; border-radius: 14px; padding: 12px 18px; font-size: 16px;
    color:#fff; font-weight: 700; cursor: pointer;
    box-shadow: 0 6px 16px rgba(0,0,0,.35);
    min-width: 200px;
  }
  .btn:active { transform: scale(.97); }
  .btn-primary { background: linear-gradient(180deg,var(--pink-hi) 0%, var(--pink) 100%); }
  .btn-indigo  { background: var(--indigo); }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<!-- In-game lane arrows -->
<div id="controls" class="controls" hidden>
  <button id="btnLane1" class="laneBtn" aria-label="Move left">◀</button>
  <button id="btnLane3" class="laneBtn" aria-label="Move right">▶</button>
</div>

<!-- Front screen buttons -->
<div id="frontButtons" hidden>
  <button id="startBtn" class="btn btn-primary">Start Game</button>
  <button id="changeNameBtn" class="btn btn-indigo">Change Name</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========================= Leaderboard (Supabase) ========================= */
const SUPABASE_URL='https://fvcvrhaxxpsientgggnx.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2Y3ZyaGF4eHBzaWVudGdnZ254Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODczMzYsImV4cCI6MjA3MTY2MzMzNn0.5wTxwGVJDa3gnS61gaDq00xSFGUMEQ0Pda6tJo4VK-A';
const TABLE_NAME='highscores';
const supa=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const NAME_KEY='catdash_name';
function getPlayerName(){
  let n=localStorage.getItem(NAME_KEY);
  if(!n){ n=prompt('Enter player name (3–12 chars):','CAT')||'CAT';
    n=n.trim().slice(0,12); if(n.length<3) n=(n+'CAT').slice(0,3);
    localStorage.setItem(NAME_KEY,n);
  }
  return n;
}
let globalBoard=[]; let lastBoardFetch=0;
async function fetchGlobalTop(limit=20){
  try{
    const {data,error}=await supa.from(TABLE_NAME).select('name,score,updated_at').order('score',{ascending:false}).limit(limit);
    if(error) throw error; globalBoard=Array.isArray(data)?data:[]; lastBoardFetch=performance.now();
  }catch(e){ console.warn('LB fetch error',e.message||e); }
}
async function submitBestIfHigher(name,score){
  try{
    const {data:existing,error:e1}=await supa.from(TABLE_NAME).select('score').eq('name',name).single();
    const prev=Number(existing?.score||0);
    if(!e1 && score<=prev) return false;
    const payload={name,score,updated_at:new Date().toISOString()};
    const {error:e2}=await supa.from(TABLE_NAME).upsert(payload,{onConflict:'name'});
    if(e2) throw e2;
    fetchGlobalTop(20); return true;
  }catch(e){ console.warn('LB submit error',e.message||e); return false; }
}

/* ========================= Canvas / Viewport ========================= */
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
function getViewportSize(){ const vv=window.visualViewport; if(vv) return {w:Math.floor(vv.width),h:Math.floor(vv.height)}; return {w:Math.floor(window.innerWidth),h:Math.floor(window.innerHeight)}; }
let {w:W,h:H}=getViewportSize(); let DPR=1;
function resizeCanvas(){ DPR=Math.max(1,Math.min(3,window.devicePixelRatio||1)); canvas.style.width=W+'px'; canvas.style.height=H+'px'; canvas.width=Math.floor(W*DPR); canvas.height=Math.floor(H*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high'; }
resizeCanvas();
function handleResize(){ const v=getViewportSize(); W=v.w; H=v.h; resizeCanvas(); positionButtons(); }
addEventListener('resize',handleResize,{passive:true});

/* ========================= Mobile buttons ========================= */
function lanesX(){ return [W/4, W/2, (3*W)/4]; }
function positionButtons(){
  const btn1=document.getElementById('btnLane1');
  const btn3=document.getElementById('btnLane3');
  const lx=lanesX();
  const baseY=H - Math.min(120, H*0.12);
  const y=Math.min(H-10, baseY + 50);
  btn1.style.left=lx[0]+'px'; btn1.style.top=y+'px';
  btn3.style.left=lx[2]+'px'; btn3.style.top=y+'px';
}
positionButtons();

/* ========================= Game State ========================= */
let mode='front';
let score=0;
let lastRun=null;

/* ========================= Front Screen ========================= */
function drawFront(){
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#ff7f7f'); g.addColorStop(.4,'#ff7a45'); g.addColorStop(.7,'#e4572e'); g.addColorStop(1,'#12161c');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  const sunR=Math.min(W,H)*0.22, sunX=W/2, sunY=H*0.62;
  const sGrad=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,sunR);
  sGrad.addColorStop(0,'#ffd27a'); sGrad.addColorStop(.6,'#ffb84a'); sGrad.addColorStop(1,'#ff9a1a');
  ctx.fillStyle=sGrad; ctx.beginPath(); ctx.arc(sunX,sunY,sunR,0,Math.PI*2); ctx.fill();

  ctx.textAlign='center';
  ctx.fillStyle='#2a0a0a'; ctx.font=`900 ${Math.min(64,Math.floor(W*0.13))}px Impact, system-ui`; ctx.fillText('GINGERBOLT', W/2, H*0.18);
  ctx.fillStyle='#fff'; ctx.font='16px system-ui';
  const lines=['Help Gingerbolt dash through danger!','Weave past trees and mud, snag snacks,','grab ⚡ to dash, and set a high score.'];
  let y=H*0.26; for(const ln of lines){ ctx.fillText(ln,W/2,y); y+=24; }

  if(lastRun!==null){
    ctx.fillStyle='#ffeb3b'; ctx.font='18px system-ui, sans-serif';
    ctx.fillText(`Your Last Run: ${Math.round(lastRun)}`, W/2, y+16);
    y+=32;
  }

  drawGlobalBoard(18, Math.min(H*0.55, H-220), 10);

  document.getElementById('frontButtons').hidden = false;
  document.getElementById('controls').hidden = true; // hide arrows on welcome
}
function drawGlobalBoard(x,y,maxRows=10){
  ctx.fillStyle='#fff'; ctx.textAlign='left'; ctx.font='18px system-ui'; ctx.fillText('Global Top 20',x,y);
  ctx.font='14px monospace'; if(!globalBoard.length){ ctx.fillText('Loading...',x,y+20); return; }
  for(let i=0;i<Math.min(maxRows,globalBoard.length);i++){
    const e=globalBoard[i]; const nm=(e.name||'???').slice(0,12);
    ctx.fillText(`${i+1}. ${nm} ${e.score}`, x, y+20+i*18);
  }
}

/* ========================= Draw ========================= */
function draw(){
  if(mode==='front'){ drawFront(); return; }
  ctx.fillStyle='#4d9c3b'; ctx.fillRect(0,0,W,H);
  ctx.fillStyle='#fff'; ctx.font='16px system-ui'; ctx.fillText('Score:'+Math.round(score),10,20);
  document.getElementById('controls').hidden = false; // show arrows only in-game
}

/* ========================= Flow ========================= */
function startGame(){
  score=0;
  mode='game';
  document.getElementById('frontButtons').hidden = true;
  document.getElementById('controls').hidden = false;
}
function endGame(){
  lastRun=score;
  mode='front';
  document.getElementById('frontButtons').hidden = false;
  document.getElementById('controls').hidden = true;
  fetchGlobalTop(20);
}

/* ========================= Loop ========================= */
let last; function loop(ts){ if(last===undefined) last=ts; let dt=(ts-last)/1000; last=ts; draw(); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

/* ========================= Inputs ========================= */
document.getElementById('startBtn').addEventListener('click',()=>startGame());
document.getElementById('changeNameBtn').addEventListener('click',()=>{ localStorage.removeItem(NAME_KEY); getPlayerName(); });

/* ========================= Boot ========================= */
getPlayerName(); fetchGlobalTop(20);
</script>
</body>
</html>
